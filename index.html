<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .dark { background-color: #0f172a; color: #f8fafc; }
        .dark .bg-white { background-color: #1e293b; color: #f1f5f9; border-color: #334155; }
        .dark .bg-slate-100 { background-color: #0f172a; }
        .dark .bg-slate-50 { background-color: #334155; }
        .dark .text-slate-800 { color: #f1f5f9; }
        .dark .text-slate-400 { color: #94a3b8; }
        .dark .border-slate-200 { border-color: #334155; }
        #telaAuth { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        .hidden { display: none !important; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .toast-anim { animation: slideUp 0.3s ease-out; }
        .password-container { position: relative; }
        .password-container input { padding-right: 2.5rem; }
        .password-toggle { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); cursor: pointer; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4 font-sans" id="corpo">

    <div id="telaAuth" class="fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-2xl w-full max-w-sm">
            <h2 id="authTitulo" class="text-2xl font-black mb-6 text-center text-slate-800 dark:text-slate-100">Financeiro Pro</h2>
            <form id="camposAuth" onsubmit="return false;" autocomplete="off" class="space-y-4">
                <!-- Anti-autofill -->
                <input type="text" name="fakeuser" style="display:none;" autocomplete="off">
                <input type="password" name="fakepass" style="display:none;" autocomplete="off">

                <input 
                    type="email" 
                    id="u_mail" 
                    placeholder="E-mail" 
                    class="w-full border rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 dark:bg-gray-700 dark:text-white"
                    autocomplete="off" 
                    autocorrect="off" 
                    autocapitalize="off" 
                    spellcheck="false"
                >
                <div class="password-container">
                    <input 
                        type="password" 
                        id="u_pass" 
                        placeholder="Senha" 
                        class="w-full border rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 dark:bg-gray-700 dark:text-white"
                        autocomplete="new-password"
                    >
                    <span class="password-toggle text-slate-400 dark:text-slate-300" onclick="togglePassword()">üëÅÔ∏è</span>
                </div>
                <button type="button" onclick="gerenciarAuth()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black uppercase shadow-lg hover:bg-blue-700 transition">Entrar</button>
                <button type="button" onclick="alternarAuth()" class="w-full text-xs font-bold text-slate-400 dark:text-slate-300 uppercase mt-2">Criar conta / Login</button>
            </form>
        </div>
    </div>

    <div id="app" class="max-w-2xl mx-auto space-y-6 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6 border-b-4 border-blue-600 flex justify-between items-center">
            <h1 class="text-2xl font-black text-slate-800 dark:text-slate-100">Minhas Contas</h1>
            <div class="flex items-center gap-4">
                <button onclick="toggleDarkMode()" class="text-slate-500 dark:text-slate-300 font-bold text-xs uppercase border border-slate-100 dark:border-gray-600 px-3 py-2 rounded-lg">üåô</button>
                <button onclick="logout()" class="text-rose-500 font-bold text-xs uppercase border border-rose-100 dark:border-rose-800 px-3 py-2 rounded-lg">Sair</button>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-gray-700">
            <p class="text-center text-slate-600 dark:text-slate-300">Bem-vindo! (Conte√∫do da app aqui)</p>
            <!-- Coloque aqui todo o resto da sua aplica√ß√£o quando quiser -->
        </div>
    </div>

    <script>
        const supabase = supabase.createClient(
            'https://hzfjdtpllocdbeqsxhly.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6ZmpkdHBsbG9jZGJlcXN4aGx5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTkxOTYsImV4cCI6MjA4NTg3NTE5Nn0.-4mugGyPB6ozbtTSgjRd_buHea3m9rf-yRnxz7BY6CA'
        );

        let isLoginMode = true;
        let userId = null;

        // Listener de mudan√ßa de autentica√ß√£o
        supabase.auth.onAuthStateChange(async (event, session) => {
            console.log('Auth state mudou:', event, session);
            if (session?.user) {
                userId = session.user.id;
                console.log('Usu√°rio logado - ID:', userId);
                entrarNoApp();
            } else {
                userId = null;
                console.log('Sem sess√£o ativa');
            }
        });

        function togglePassword() {
            const input = document.getElementById('u_pass');
            const icon = document.querySelector('.password-toggle');
            input.type = input.type === 'password' ? 'text' : 'password';
            icon.textContent = input.type === 'password' ? 'üëÅÔ∏è' : 'üôà';
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark');
        }

        function alternarAuth() {
            isLoginMode = !isLoginMode;
            document.getElementById('authTitulo').textContent = isLoginMode ? 'Financeiro Pro' : 'Criar Conta';
        }

        async function gerenciarAuth() {
            const email = document.getElementById('u_mail').value.trim();
            const password = document.getElementById('u_pass').value;

            console.log('Bot√£o clicado - dados:', { email, modo: isLoginMode ? 'Login' : 'Cadastro' });

            if (!email || password.length < 6) {
                avisar('Preencha e-mail e senha v√°lidos (m√≠nimo 6 caracteres)', 'erro');
                return;
            }

            avisar('Tentando autenticar...', 'info');

            try {
                let result;
                if (isLoginMode) {
                    result = await supabase.auth.signInWithPassword({ email, password });
                } else {
                    result = await supabase.auth.signUp({ email, password });
                }

                const { data, error } = result;

                console.log('Resposta completa do Supabase:', { data, error });

                if (error) {
                    console.error('Erro do Supabase:', error.message, error);
                    avisar(error.message || 'Falha na autentica√ß√£o. Verifique email/senha.', 'erro');
                    return;
                }

                console.log('Sucesso na autentica√ß√£o:', data);

                // Verifica sess√£o imediatamente
                const { data: sessionData, error: sessionErr } = await supabase.auth.getSession();
                if (sessionErr) {
                    console.error('Erro ao verificar sess√£o:', sessionErr);
                    avisar('Problema ao confirmar login', 'erro');
                } else if (sessionData?.session) {
                    userId = sessionData.session.user.id;
                    console.log('Sess√£o confirmada. Entrando no app.');
                    avisar('Login realizado com sucesso!', 'sucesso');
                    entrarNoApp();
                } else {
                    avisar('Sess√£o n√£o encontrada ap√≥s login. Tente novamente.', 'erro');
                }

            } catch (err) {
                console.error('Exce√ß√£o inesperada:', err);
                avisar('Erro de conex√£o ou servidor. Verifique sua internet.', 'erro');
            }
        }

        function entrarNoApp() {
            console.log('Chamando entrarNoApp - ocultando auth');
            document.getElementById('telaAuth').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            avisar('Bem-vindo ao Financeiro Pro!', 'sucesso');
        }

        function avisar(msg, tipo = 'info') {
            const cores = { erro: 'bg-rose-600', sucesso: 'bg-emerald-600', info: 'bg-blue-600' };
            const toast = document.createElement('div');
            toast.className = `fixed bottom-6 right-6 ${cores[tipo]} text-white px-6 py-4 rounded-2xl shadow-2xl z-[200] font-bold text-sm toast-anim`;
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // Logout (para teste)
        async function logout() {
            await supabase.auth.signOut();
            location.reload();
        }
    </script>
</body>
</html>
